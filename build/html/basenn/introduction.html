<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BaseNN功能详解 &mdash; OpenXLabEdu  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BaseNN项目案例集" href="projects.html" />
    <link rel="prev" title="BaseNN安装或下载" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            OpenXLabEdu
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">关于XEdu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_quick_start.html">XEdu快速入门手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xedu_hub.html">深度学习工具库XEduHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mmedu.html">计算机视觉库MMEdu</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../basenn.html">神经网络库BaseNN</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quick_start.html">快速体验BaseNN，开始！</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html">BaseNN安装或下载</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">BaseNN功能详解</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">BaseNN是什么？</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">示例代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">解锁BaseNN基本使用方法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">0. 引入包</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">1. 声明模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">2. 载入数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">3. 搭建模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">4. 模型训练</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">训练篇拓展——分数据类型看训练代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">5. 模型推理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">推理篇拓展——直接传文件路径完成推理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">6. 模型文件格式转换</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id26">高级功能</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cnn">1.提取CNN特征</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">2.网络中特征可视化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">3.查看模型结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id29">4.自定义随机数种子</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id30">5.自定义损失函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">6.自定义评价指标</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id32">由此拓展-自定义评价函数和训练策略</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">7.探秘权重文件</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="projects.html">BaseNN项目案例集</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html">附录</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../baseml.html">传统机器学习库BaseML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../easydl.html">EasyDL系列无代码工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basedt.html">数据处理库BaseDT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basedeploy.html">模型部署库BaseDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_use.html">如何用XEdu借助AI解决真实问题</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenXLabEdu</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../basenn.html">神经网络库BaseNN</a></li>
      <li class="breadcrumb-item active">BaseNN功能详解</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/basenn/introduction.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="basenn">
<h1>BaseNN功能详解<a class="headerlink" href="#basenn" title="Permalink to this heading"></a></h1>
<section id="id1">
<h2>BaseNN是什么？<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p>BaseNN是神经网络库，能够使用类似Keras却比Keras门槛更低的的语法搭建神经网络模型。可支持逐层搭建神经网络，深入探究网络原理。如果有如下需求，可以优先选择BaseNN：</p>
<p>a）简易和快速地搭建神经网络</p>
<p>b）支持搭建<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/introduction.html#rnncnn">CNN和RNN</a>，或二者的结合</p>
<p>c）同时支持CPU和GPU</p>
<p>文档涉及的部分代码见XEdu帮助文档配套项目集：<a class="reference external" href="https://www.openinnolab.org.cn/pjlab/project?id=64f54348e71e656a521b0cb5&amp;sc=645caab8a8efa334b3f0eb24#public">https://www.openinnolab.org.cn/pjlab/project?id=64f54348e71e656a521b0cb5&amp;sc=645caab8a8efa334b3f0eb24#public</a></p>
</section>
<section id="id2">
<h2>示例代码<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">train_path</span> <span class="o">=</span> <span class="s1">&#39;../../dataset/iris/iris_training.csv&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_tab_data</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;Softmax&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">save_fold</span> <span class="o">=</span> <span class="s1">&#39;./iris_ckpt&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>解锁BaseNN基本使用方法<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h2>
<section id="id4">
<h3>0. 引入包<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">BaseNN</span> <span class="kn">import</span> <span class="n">nn</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>1. 声明模型<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span> 
</pre></div>
</div>
<p>可选参数：</p>
<p><code class="docutils literal notranslate"><span class="pre">task</span></code>：指定了这个模型要完成的任务，可选取值有：<code class="docutils literal notranslate"><span class="pre">['reg','cls','gen']</span></code>，</p>
<p>回归任务：nn(’reg’)。</p>
<p>分类任务：nn(’cls’)，当不指定时，<code class="docutils literal notranslate"><span class="pre">task</span></code>的默认值<code class="docutils literal notranslate"><span class="pre">'cls'</span></code>。</p>
<p>生成任务：nn(’gen’)。</p>
</section>
<section id="id6">
<h3>2. 载入数据<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<p>根据数据类型，可选择使用<code class="docutils literal notranslate"><span class="pre">load_img_data</span></code>、<code class="docutils literal notranslate"><span class="pre">load_tab_data</span></code>等（持续更新中）直接载入不同类型数据的函数，在这些函数中封装了读取数据并进行预处理的功能。下面分数据类型进行说明：</p>
<section id="id7">
<h4>针对图片文件夹类型的数据：<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h4>
<p>直接指定图片文件夹路径，再使用<code class="docutils literal notranslate"><span class="pre">load_img_data</span></code>函数即可完成载入数据，对图片文件夹格式有一定要求：大文件夹下包含各个按类别命名的子文件夹。例如此处使用的是经过处理的经典的MNIST手写体数字图像数据集。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">image_folder_data</span> <span class="o">=</span> <span class="s1">&#39;../../dataset/mnist/training_set&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_img_data</span><span class="p">(</span><span class="n">image_folder_data</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grayscale&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
</pre></div>
</div>
<p>参数说明：</p>
<p><code class="docutils literal notranslate"><span class="pre">train_val_ratio</span></code>：0~1之间的浮点数，表示训练集的占比，默认为1。eg，数据集共1万张，train_val_ratio=0.8，则8000张训练集，2000张验证集。若传入大于1或小于0的错误比例，则参数值无效，默认整个数据集都可用于训练。此参数可用于拆分数据集为训练集和验证集。</p>
<p><code class="docutils literal notranslate"><span class="pre">color</span></code>：设置为”grayscale”或”RGB”，表示图片的颜色空间或色彩模式，可以根据具体的需求来选择适合的模式。如果将color参数设置为”grayscale”，表示希望将图像转换为灰度图像，仅包含亮度信息。如果将color参数设置为”RGB”，表示希望保留图像的红、绿、蓝三个通道的颜色信息，得到彩色图像。</p>
<p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>：表示在一次训练中同时处理的样本数量。通常情况下，批量大小越大，模型的收敛速度越快，但内存和计算资源的需求也会相应增加。</p>
<p><code class="docutils literal notranslate"><span class="pre">batch_model</span></code>：是否按照minibatch的模式读取数据，若 False，则载入数据时读取全部图像，若 True，则载入数据时仅读取图像路径，训练时再读取对应batch的图像。默认为 False，Fasle要求内存大， 速度快，True则速度慢，要求内存小，如载入图像文件夹时出现内核中断，可增设<code class="docutils literal notranslate"><span class="pre">batch_model=True</span></code>。</p>
<p><code class="docutils literal notranslate"><span class="pre">num_workers</span></code>：线程数，决定了有多少个子线程被用于数据加载。子线程是并行运行的，可以同时处理多个数据批次。增加 <code class="docutils literal notranslate"><span class="pre">num_workers</span></code> 的数值时，可以加快数据批次的寻找速度，这通常会提高训练的速度，因为模型等待数据的时间减少了，但增大内存开销和CPU负荷。此参数用来控制数据加载过程中的线程数量。适当增加这个数值可以加速训练，但也要注意不要超出你的硬件限制。默认为0，一般而言设置num_workers最大为CPU核心数。</p>
<p><code class="docutils literal notranslate"><span class="pre">classes</span></code>：类别列表（列表）或字典，表示数据集中的<code class="docutils literal notranslate"><span class="pre">label</span></code>中存储的数组各个位置标签所代表的意义，一般适用于载入图片形式数据集训练图像分类模型。可以不传入，若不传入，则推理结果将会是认为结果的下标。若传入，则推理结果将自动转化为将原结果作为下标的数组中的对应内容。</p>
<p>classes可传参数兼容列表，字典形式(以下三种形式均可)。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="s1">&#39;dog&#39;</span><span class="p">]</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;dog&#39;</span><span class="p">}</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cat&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="c1"># 与词表形式统一</span>
</pre></div>
</div>
<p>注意：索引是数值类型（int)，类别名称是字符串（str)，即哪怕类别名也是数字0,1,…字典的键和值也有区别，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 正确示例</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">}</span> <span class="c1"># 索引to类别</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> <span class="c1"># 类别to索引</span>

<span class="c1"># 错误示例</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span> 
<span class="n">classes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">}</span> 
</pre></div>
</div>
</section>
<section id="id8">
<h4>关于图片数据集预处理：<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h4>
<p>载入图片数据前如需对图像数据集进行预处理，最常见的例如做尺寸调整，可先调用已经内置的torchvision对图片数据集进行预处理再载入模型进行训练，只需在<code class="docutils literal notranslate"><span class="pre">load_img_data</span></code>图片数据集时增加一个<code class="docutils literal notranslate"><span class="pre">transform</span></code>的参数。</p>
<p>此处为对数据进行单个步骤的简单处理。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_img_data</span><span class="p">(</span><span class="s1">&#39;MNIST&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Resize&quot;</span><span class="p">:(</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">)})</span>
</pre></div>
</div>
<p>若要对图片数据进行多次处理的复杂操作，可以采用如下代码，将多个处理方式设置入参数，在执行时这些操作也会被按顺序执行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_img_data</span><span class="p">(</span><span class="s1">&#39;catdog&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Resize&quot;</span><span class="p">:(</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">),</span><span class="s2">&quot;RandomResizedCrop&quot;</span><span class="p">:</span><span class="mi">224</span><span class="p">,</span><span class="s2">&quot;RandomHorizontalFlip&quot;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">})</span>
</pre></div>
</div>
<p>方法说明: <code class="docutils literal notranslate"><span class="pre">Resize</span></code>:对图片尺寸进行调整。</p>
<p><code class="docutils literal notranslate"><span class="pre">RandomResizedCrop</span></code>:对图片尺寸进行随机缩放后裁剪为固定尺寸。</p>
<p><code class="docutils literal notranslate"><span class="pre">RandomHorizontalFlip</span></code>:依照某概率对图片进行水平翻转。</p>
<p>支持的操作即为<a class="reference external" href="https://pytorch-cn.readthedocs.io/zh/latest/torchvision/torchvision-transform/">torchvision中的transforms</a>包括的所有方式，如下表所列。</p>
<table class="docutils align-default">
<thead>
  <tr>
    <th>类别</th>
    <th>转换名称</th>
    <th>函数</th>
    <th>设置示例</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>裁剪</td>
    <td>随机裁剪</td>
    <td>RandomCrop</td>
    <td>(32, 32)</td> 
  </tr>
</tbody>
<tbody>
  <tr>
    <td>裁剪</td>
    <td>中心裁剪</td>
    <td>CenterCrop</td>
    <td>(32, 32)</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>裁剪</td>
    <td>随机长宽比裁剪</td>
    <td>RandomResizedCrop</td>
    <td>size=224, scale=(0.08, 1.0), ratio=(0.75, 1.33), interpolation=2</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>裁剪</td>
    <td>上下左右中心裁剪</td>
    <td>FiveCrop</td>
    <td>(32, 32)</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>裁剪</td>
    <td>上下左右中心裁剪后翻转</td>
    <td>TenCrop</td>
    <td>size=(32, 32), vertical_flip=False</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>翻转和旋转</td>
    <td>依概率p水平翻转</td>
    <td>RandomHorizontalFlip</td>
    <td>0.5</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>翻转和旋转</td>
    <td>依概率p垂直翻转</td>
    <td>RandomVerticalFlip</td>
    <td>0.5</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>翻转和旋转</td>
    <td>随机旋转</td>
    <td>RandomRotation</td>
    <td>(0, 180)</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>尺寸调整</td>
    <td>Resize</td>
    <td>(128, 128)</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>标准化</td>
    <td>Normalize</td>
    <td>mean=(0.485, 0.456, 0.406), std=(0.229, 0.224, 0.225)</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>转为tensor</td>
    <td>ToTensor</td>
    <td>无参数设置示例</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>填充</td>
    <td>Pad</td>
    <td>4</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>修改亮度、对比度和饱和度</td>
    <td>ColorJitter</td>
    <td>brightness=0.2, contrast=0.2, saturation=0.2, hue=0.1</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>转灰度图</td>
    <td>Grayscale</td>
    <td>1</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>线性变换</td>
    <td>LinearTransformation</td>
    <td>transformation_matrix, mean_vector</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>仿射变换</td>
    <td>RandomAffine</td>
    <td>degrees=30, translate=(0.1, 0.1), scale=(0.8, 1.2), shear=10</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>依概率p转为灰度图</td>
    <td>RandomGrayscale</td>
    <td>0.1</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>将数据转换为PILImage</td>
    <td>ToPILImage</td>
    <td>无参数设置示例</td>
  </tr>
</tbody>
<tbody>
  <tr>
    <td>图像变换</td>
    <td>自定义Lambda变换</td>
    <td>Lambda</td>
    <td>lambda x: x.div(255)</td>
  </tr>
</tbody>
</table></section>
<section id="id9">
<h4>针对特征表格类型的数据：<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h4>
<p>指定表格路径，再使用<code class="docutils literal notranslate"><span class="pre">load_tab_data</span></code>函数即可完成载入数据，对表格的要求：csv格式，纵轴为样本，横轴为特征，第一行为表头，最后一列为标签，且要求数据类型为数值类型并无缺失值。例如此处我使用的是经过处理的经典的Iris鸢尾花数据集。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_path</span> <span class="o">=</span> <span class="s1">&#39;../../dataset/iris/iris_training.csv&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_tab_data</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>：表示在一次训练中同时处理的样本数量。通常情况下，批量大小越大，模型的收敛速度越快，但内存和计算资源的需求也会相应增加。</p>
<p><code class="docutils literal notranslate"><span class="pre">num_workers</span></code>：线程数，决定了有多少个子线程被用于数据加载。子线程是并行运行的，可以同时处理多个数据批次。增加 <code class="docutils literal notranslate"><span class="pre">num_workers</span></code> 的数值时，可以加快数据批次的寻找速度，这通常会提高训练的速度，因为模型等待数据的时间减少了，但增大内存开销和CPU负荷。此参数用来控制数据加载过程中的线程数量。适当增加这个数值可以加速训练，但也要注意不要超出你的硬件限制。默认为0，一般而言设置num_workers最大为CPU核心数。</p>
</section>
<section id="npz">
<h4>针对NPZ数据集类型的数据：<a class="headerlink" href="#npz" title="Permalink to this heading"></a></h4>
<p>指定NPZ数据集路径，再使用<code class="docutils literal notranslate"><span class="pre">load_npz_data</span></code>函数即可完成载入数据。NPZ格式，是numpy的一种压缩格式，对NPZ数据集的要求：npz格式(numpy zip)，其中至少应该拥有两个键，分别为<code class="docutils literal notranslate"><span class="pre">data</span></code>与<code class="docutils literal notranslate"><span class="pre">label</span></code>，其中<code class="docutils literal notranslate"><span class="pre">data</span></code>中存储的应为训练数据信息，<code class="docutils literal notranslate"><span class="pre">label</span></code>中存储的应为数据所对应的标签信息（应为数组形式）。</p>
<p>详见案例：<a class="reference external" href="https://www.openinnolab.org.cn/pjlab/project?id=64daed3eafeb1059822a1578&amp;sc=62f33550bf4f550f3e926cf2#public">姿态识别进阶-循环神经网络</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_path</span> <span class="o">=</span> <span class="s1">&#39;../../dataset/dataset.npz&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_npz_data</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;walking&quot;</span><span class="p">,</span><span class="s2">&quot;waving&quot;</span><span class="p">,</span><span class="s2">&quot;stretching&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>参数说明：</p>
<p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code>：表示在一次训练中同时处理的样本数量。通常情况下，批量大小越大，模型的收敛速度越快，但内存和计算资源的需求也会相应增加。</p>
<p><code class="docutils literal notranslate"><span class="pre">classes</span></code>：表示数据集中的<code class="docutils literal notranslate"><span class="pre">label</span></code>中存储的数组各个位置标签所代表的意义。可以不传入，若不传入，则推理结果将会是认为结果的下标。若传入，则推理结果将自动转化为将原结果作为下标的数组中的对应内容。</p>
<p><code class="docutils literal notranslate"><span class="pre">num_workers</span></code>：指定线程数，决定了有多少个子线程被用于数据加载。子线程是并行运行的，可以同时处理多个数据批次。增加 <code class="docutils literal notranslate"><span class="pre">num_workers</span></code> 的数值时，可以加快数据批次的寻找速度，这通常会提高训练的速度，因为模型等待数据的时间减少了，但增大内存开销和CPU负荷。此参数用来控制数据加载过程中的线程数量。适当增加这个数值可以加速训练，但也要注意不要超出你的硬件限制。默认为0，一般而言设置num_workers最大为CPU核心数。</p>
<ul class="simple">
<li><p>小帖士（井号后面是运行结果）：</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;dataset.npz&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># &lt;numpy.lib.npyio.NpzFile object at 0x7f319c448ac0&gt;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>  <span class="c1"># 这是一个三分类标签数据，它是二维数据，每一条数据里面是三分类独热编码标签。</span>
<span class="c1"># array([[1, 0, 0],</span>
<span class="c1">#          ...,</span>
<span class="c1">#        [0, 0, 1]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="c1"># 这是一个高维数据，每一条数据对应一个标签，但是数据本身不是一维的，而是高纬的。</span>
<span class="c1"># array([[[ 4.60664570e-01,  2.78294533e-01, -3.56185764e-01, ...,</span>
<span class="c1">#          9.21180844e-01,  1.94783360e-01,  9.93974388e-01],</span>
<span class="c1">#        [ 4.62414086e-01,  2.83538818e-01, -3.53962898e-01, ...,</span>
<span class="c1">#          9.16427970e-01,  1.96989119e-01,  9.91852582e-01],</span>
<span class="c1">#        [ 4.63086247e-01,  2.80452102e-01, -3.24477255e-01, ...,</span>
<span class="c1">#          9.19000983e-01,  1.50782943e-01,  9.93449986e-01],</span>
<span class="c1">#        ...,</span>
<span class="c1">#        [ 4.34215039e-01,  4.27498937e-01,  3.03461671e-01, ...,</span>
<span class="c1">#          8.96103501e-01, -4.72080037e-02,  9.73582983e-01]]])</span>
</pre></div>
</div>
<p>len(data[’data’])和len(data[’label’])是相等的。</p>
<p>对于案例<a class="reference external" href="https://www.openinnolab.org.cn/pjlab/project?id=64daed3eafeb1059822a1578&amp;sc=62f33550bf4f550f3e926cf2#public">《姿态识别进阶-循环神经网络》</a>
来说：<code class="docutils literal notranslate"><span class="pre">data['label'].shape</span></code>是(19, 3)，<code class="docutils literal notranslate"><span class="pre">data['data'].shape</span></code>是(19, 30, 132)。</p>
<p><code class="docutils literal notranslate"><span class="pre">type(data['data'])</span></code>的运行结果是numpy.ndarray，<code class="docutils literal notranslate"><span class="pre">type(data['data'])</span></code>的运行结果是numpy.ndarray。</p>
</section>
<section id="id10">
<h4>拓展——自行编写代码载入数据：<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h4>
<p>如您想要尝试自行编写代码加载数据并做预处理，需生成NumPy数组格式的特征<code class="docutils literal notranslate"><span class="pre">x</span></code> 和标签<code class="docutils literal notranslate"><span class="pre">y</span></code>（不同的框架和模型可能对输入数据的格式有所要求有所不同，这是BaseNN的要求），载入时可使用如下代码，此方法比较灵活。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>也支持设置线程数参数<code class="docutils literal notranslate"><span class="pre">num_workers</span></code>，此参数用来控制数据加载过程中的线程数量。适当增加这个数值可以加速训练，但也要注意不要超出你的硬件限制。默认为0，一般而言设置num_workers最大为CPU核心数。</p>
<p>此处采用Iris鸢尾花数据集和MNIST手写体数字图像数据集作为示例。</p>
<p>读取并载入csv格式鸢尾花数据集（鸢尾花数据集以鸢尾花的特征作为数据来源，数据集包含150条数据，有4维（花萼长度、宽度和花瓣长度、宽度），分为3类（setosa、versicolour、virginica），每类50条数据）：</p>
<p>数据集共有5列，其中前四列为特征，第五列为鸢尾花的类别，即标签。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 训练数据</span>
<span class="n">train_path</span> <span class="o">=</span> <span class="s1">&#39;../dataset/iris/iris_training.csv&#39;</span> 
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="c1"># 读取前四列，特征</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 读取第五列，标签</span>
<span class="c1"># 测试数据</span>
<span class="n">test_path</span> <span class="o">=</span> <span class="s1">&#39;../dataset/iris/iris_test.csv&#39;</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="c1"># 读取前四列，特征</span>
<span class="n">test_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 读取第五列，标签</span>
<span class="c1"># 将数据载入</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>上面这段代码使用了NumPy库加载和预处理Iris鸢尾花数据集。代码首先指定了训练数据集和测试数据集的路径，然后使用<code class="docutils literal notranslate"><span class="pre">np.loadtxt</span></code>函数从CSV文件中读取特征和标签数据，并存储在<code class="docutils literal notranslate"><span class="pre">x</span></code>和<code class="docutils literal notranslate"><span class="pre">y</span></code>变量中。测试数据也以相同的方式加载并存储在<code class="docutils literal notranslate"><span class="pre">test_x</span></code>和<code class="docutils literal notranslate"><span class="pre">test_y</span></code>变量中。最后，通过调用<code class="docutils literal notranslate"><span class="pre">model.load_dataset(x,</span> <span class="pre">y)</span></code>将数据集载入模型。</p>
<p>读取并载入手写体图像数据集（数据集包含了0-9共10类手写数字图片，都是28x28大小的灰度图）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义读取训练数据的函数</span>
<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># 将顺序读取的文件保存到该list中</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dir_list</span><span class="p">:</span>
        <span class="n">tpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># print(tpath)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tpath</span><span class="p">):</span>
            <span class="c1"># print(item)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
            <span class="n">imGray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="c1"># print(img)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imGray</span><span class="p">)</span>
            <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

<span class="c1"># 读取训练数据</span>
<span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="s1">&#39;../dataset/mnist/training_set&#39;</span><span class="p">)</span>
<span class="c1"># 载入数据</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span> 
</pre></div>
</div>
<p>上面这段代码中定义了一个名为<code class="docutils literal notranslate"><span class="pre">read_data</span></code>的函数，该函数用于从指定路径中读取MNIST训练数据。该函数首先遍历给定路径中的文件夹，然后读取每个文件夹中的图像数据，并将其转换为灰度图像。读取的图像数据被存储在<code class="docutils literal notranslate"><span class="pre">data</span></code>列表中，相应的标签存储在<code class="docutils literal notranslate"><span class="pre">label</span></code>列表中。最后，通过<code class="docutils literal notranslate"><span class="pre">np.array</span></code>将数据和标签转换为NumPy数组，并使用<code class="docutils literal notranslate"><span class="pre">np.expand_dims</span></code>函数在数据维度上进行扩展，以适应模型的输入要求。</p>
</section>
</section>
<section id="id11">
<h3>3. 搭建模型<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h3>
<p>逐层添加，搭建起模型结构，支持CNN（卷积神经网络）和RNN（循环神经网络）。注释标明了数据经过各层的尺寸变化。在模型搭建中要特别注意数据经过各层的尺寸变化，以设置正确的<code class="docutils literal notranslate"><span class="pre">size</span></code>值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span> <span class="c1"># [120, 10]</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span> <span class="c1"># [120, 5]</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span> <span class="c1"># [120, 3]</span>
</pre></div>
</div>
<p>以上使用<code class="docutils literal notranslate"><span class="pre">add()</span></code>方法添加层，参数<code class="docutils literal notranslate"><span class="pre">layer='linear'</span></code>表示添加的层是线性层，<code class="docutils literal notranslate"><span class="pre">size=(4,10)</span></code>表示该层输入维度为4，输出维度为10，<code class="docutils literal notranslate"><span class="pre">activation='relu'</span></code>表示使用relu激活函数。以上代码搭建的是一个输入维度为4，输出维度为3，隐藏层数量为2的全连接神经网络。如要搭建更加复杂的神经网络，可前往<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#add">附录1</a>了解更详细的<code class="docutils literal notranslate"><span class="pre">add()</span></code>方法使用，还呈现了搭建<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#id3">全连接神经网络结构</a>、<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#id4">简单卷积神经网络LeNet结构</a>，也呈现了与MMEdu内置的SOTA模型对应的<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#mobilenet">MobileNet网络</a>、<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#resnet">ResNet</a>等，以及<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#id5">循环神经网络</a>、<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#id7">扩散模型</a>等搭建说明。</p>
</section>
<section id="id12">
<h3>4. 模型训练<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<p>模型训练可以采用以下函数，训练前需设置模型保存路径，训练时需设置lr、epochs等超参数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置模型保存的路径</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_fold</span> <span class="o">=</span> <span class="s1">&#39;checkpoints/irs_ckpt&#39;</span>
<span class="c1"># 模型训练</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
<p>参数<code class="docutils literal notranslate"><span class="pre">lr</span></code>为学习率，<code class="docutils literal notranslate"><span class="pre">epochs</span></code>为训练轮数。</p>
<p>从训练类型的角度，可以分为正常训练和继续训练。</p>
<p>使用<code class="docutils literal notranslate"><span class="pre">model.save_fold</span></code>设置模型保存的路径，模型权重文件格式为<code class="docutils literal notranslate"><span class="pre">.pth</span></code>文件格式。默认保存为保存路径下的命名为basenn.pth的文件，如需修改保存命名，可在train中加入一个新参数<code class="docutils literal notranslate"><span class="pre">filename</span></code>，设置方法为<code class="docutils literal notranslate"><span class="pre">filename='XX.pth'</span></code>。</p>
<section id="id13">
<h4>正常训练<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span> <span class="c1"># [120, 10]</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)</span> <span class="c1"># [120, 5]</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span> <span class="c1"># [120, 3]</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_fold</span> <span class="o">=</span> <span class="s1">&#39;checkpoints&#39;</span> <span class="c1"># 指定模型保存路径</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">model.save_fold</span></code>表示训练出的模型文件保存的文件夹。</p>
</section>
<section id="id14">
<h4>继续训练<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">checkpoint</span> <span class="o">=</span> <span class="s1">&#39;checkpoints/basenn.pth&#39;</span> <span class="c1"># 指定已有模型的权重文件路径</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">checkpoint</span></code>为现有模型路径，当使用<code class="docutils literal notranslate"><span class="pre">checkpoint</span></code>参数时，模型基于一个已有的模型继续训练，不使用<code class="docutils literal notranslate"><span class="pre">checkpoint</span></code>参数时，模型从零开始训练。</p>
</section>
</section>
<section id="id15">
<h3>训练篇拓展——分数据类型看训练代码<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h3>
<p>针对不同类型的数据类型，载入数据、搭建模型和模型训练的代码会略有不同。深度学习常见的数据类型介绍详见<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#id14">附录4</a>。</p>
<section id="id16">
<h4>第一种：图片文件夹类型<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h4>
<p>可直接指定图片文件夹，同时针对图片数据可增加classes参数设置（推理时会输出预测的类别名称，如不设置此参数则只输出类别标签），参考代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_img_data</span><span class="p">(</span><span class="s2">&quot;./mnist/training_set&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grayscale&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Conv2D&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;AvgPool&#39;</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Conv2D&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;AvgPool&#39;</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span>  
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> 
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;Softmax&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;SGD&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_fold</span> <span class="o">=</span> <span class="s1">&#39;new_mn_ckpt&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;new_mn_ckpt/basenn.pth&quot;</span><span class="p">)</span> <span class="c1"># 继续训练</span>
</pre></div>
</div>
<p>如自己进行对图片数据处理后，使用<code class="docutils literal notranslate"><span class="pre">load_dataset(x,</span> <span class="pre">y)</span></code>载入数据，可使用如下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">)</span> <span class="c1"># classes是类别列表（列表） //字典</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;conv2d&#39;</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id17">
<h4>第二种：特征类型<a class="headerlink" href="#id17" title="Permalink to this heading"></a></h4>
<p>可直接指定csv格式的表格完成模型训练，参考代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">train_path</span> <span class="o">=</span> <span class="s1">&#39;../../dataset/iris/iris_training.csv&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_tab_data</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> <span class="c1"># [120, 10]</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;ReLU&#39;</span><span class="p">)</span> <span class="c1"># [120, 5]</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;Softmax&#39;</span><span class="p">)</span> <span class="c1"># [120, 3]</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_fold</span> <span class="o">=</span> <span class="s1">&#39;./iris_ckpt&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
<p>对表格的要求：csv格式，纵轴为样本，横轴为特征，第一行为表头，最后一列为标签。</p>
<p>当然您也可以自行编写代码来加载数据并进行预处理，然后将生成的输入特征 <code class="docutils literal notranslate"><span class="pre">x</span></code>
和目标标签 <code class="docutils literal notranslate"><span class="pre">y</span></code>
传递给模型。针对特征数据，使用BaseNN各模块的示例代码即可。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_fold</span> <span class="o">=</span> <span class="s1">&#39;./iris_ckpt&#39;</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id18">
<h4>第三种：文本类型<a class="headerlink" href="#id18" title="Permalink to this heading"></a></h4>
<p>在做文本生成等NLP（自然语言处理）领域项目时，一般<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#rnncnn">搭建RNN网络</a>训练模型，训练数据是文本数据，参考代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">word2idx</span><span class="o">=</span><span class="n">word2idx</span><span class="p">)</span> <span class="c1"># word2idx是词表（字典）</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;lstm&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="mi">256</span><span class="p">),</span><span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id19">
<h3>5. 模型推理<a class="headerlink" href="#id19" title="Permalink to this heading"></a></h3>
<p>可使用以下函数进行推理：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span> <span class="c1"># 声明模型</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="s1">&#39;checkpoints/iris_ckpt/basenn.pth&#39;</span> <span class="c1"># 现有模型路径</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_x</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span> <span class="c1"># 直接推理</span>
<span class="n">model</span><span class="o">.</span><span class="n">print_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="c1"># 输出字典格式结果</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">checkpoint</span></code>为已有模型路径，即使用现有的模型进行推理。</p>
<p>直接推理的输出结果数据类型为<code class="docutils literal notranslate"><span class="pre">NumPy</span></code>的二维数组，表示各个样本的各个特征的置信度。</p>
<p>输出字典格式结果的数据类型为字典，格式为<code class="docutils literal notranslate"><span class="pre">{样本编号：{预测值：x，置信度：y}}</span></code>。<code class="docutils literal notranslate"><span class="pre">print_result()</span></code>函数调用即输出，但也有返回值。</p>
<p>参数<code class="docutils literal notranslate"><span class="pre">data</span></code>为待推理的测试数据，该参数必须传入值，可以传入NumPy数组或文件路径或者dataloader类型的数据，也可以传入list（最终还是会转成numpy数组）。除了NumPy数组格式和list数组格式的特征数据，以及传入dataloader类型的数据进行批量的模型推理外，还可以直接传入文件路径进行模型推理，下面我们分文件类型说明。</p>
<p>**注：**推理时传入的数据要和模型训练时使用的训练集的数据保持一致。</p>
</section>
<section id="id20">
<h3>推理篇拓展——直接传文件路径完成推理<a class="headerlink" href="#id20" title="Permalink to this heading"></a></h3>
<section id="id21">
<h4>针对单个图片文件的推理：<a class="headerlink" href="#id21" title="Permalink to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="s2">&quot;mnist/val_set/7/83.jpg&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_x</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;mn_ckpt/basenn.pth&quot;</span><span class="p">)</span> <span class="c1"># 推理某张图片</span>
<span class="n">model</span><span class="o">.</span><span class="n">print_result</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id22">
<h4>针对图片文件夹的推理：<a class="headerlink" href="#id22" title="Permalink to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="s2">&quot;mnist/val_set/7&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">test_x</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;mn_ckpt/basenn.pth&quot;</span><span class="p">)</span> <span class="c1"># 推理整个测试集</span>
<span class="n">model</span><span class="o">.</span><span class="n">print_result</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id23">
<h4>针对特征表格文件的推理：<a class="headerlink" href="#id23" title="Permalink to this heading"></a></h4>
<p>简便方法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">test_path</span> <span class="o">=</span> <span class="s1">&#39;data/iris_test.csv&#39;</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;iris_ckpt/basenn.pth&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">print_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<p>使用此方法，对表格文件有严格要求：csv格式，纵轴为样本，横轴为特征，第一行为表头，最后一列为标签</p>
<p><code class="docutils literal notranslate"><span class="pre">label=True</span></code>：csv文件中含标签列，比如iris_test.csv；False为没有标签，如果指定的csv最后一列不是标签，则使用False。</p>
<p>常规方法：先读取文件的特征列。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">test_path</span> <span class="o">=</span> <span class="s1">&#39;data/iris_test.csv&#39;</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> 
<span class="n">res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">test_x</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;checkpoints/iris_ckpt/basenn.pth&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">print_result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id24">
<h4>针对文本数据的推理：<a class="headerlink" href="#id24" title="Permalink to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;长&#39;</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="s1">&#39;xxx.pth&#39;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 取得概率最大的字的索引，当然也可以取别的，自行选择即可</span>
<span class="n">word</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">idx2word</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="c1"># 根据词表获得对应的字</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">result</span></code>为列表包含两个变量：<code class="docutils literal notranslate"><span class="pre">[output,</span> <span class="pre">hidden]</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output</span></code>为NumPy数组，里面是一系列概率值，对应每个字的概率。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hidden</span></code>为高维向量，存储上下文信息，代表”记忆”，所以生成单个字可以不传入hidden，但写诗需要循环传入之前输出的hidden。</p></li>
</ul>
</section>
</section>
<section id="id25">
<h3>6. 模型文件格式转换<a class="headerlink" href="#id25" title="Permalink to this heading"></a></h3>
<p>使用BaseNN训练好的模型权重会以.pth格式的文件保存到本地，但是以.pth格式保存文件不利于模型的部署以及推理，因此我们希望将.pth文件转换成.onnx格式的文件，这样就可以将模型快速部署并进行推理啦。比如，可以使用XEduHub工具，利用转换好的onnx文件进行模型推理。</p>
<p>模型格式转换代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">BaseNN</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;basenn_cd.pth&quot;</span><span class="p">,</span><span class="n">out_file</span><span class="o">=</span><span class="s2">&quot;basenn_cd.onnx&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>参数说明：</p>
<p><code class="docutils literal notranslate"><span class="pre">checkpoint</span></code>: 指定要转换的pth模型文件路径。</p>
<p><code class="docutils literal notranslate"><span class="pre">out_file</span></code>: 指定转换出的onnx模型文件路径。</p>
<p><code class="docutils literal notranslate"><span class="pre">opset_version</span></code>：指定转换出的onnx模型算子的版本，默认为10，一般情况下不需要进行设置，除非出现了算子版本不符而导致的报错。【可选参数】</p>
<p><code class="docutils literal notranslate"><span class="pre">ir_version</span></code>：指定中间表示（Intermediate Representation, 简称 IR）规范的版本，一个整数（int）类型的参数。当前可选范围为1～12，默认为6。在计算机编程中，中间表示是一种数据结构或代码，它介于原始代码和机器码之间。它通常用于编译器或类似工具中，作为转换和优化代码的一个步骤。指定中间表示的版本，可方便根据不同的需求和优化目标选择最合适的 IR 规范。【可选参数】</p>
<p><strong>注意！</strong>：在转换为onnx文件后会将模型的元信息，如数据类型、输入尺寸等也写入模型文件，而之前版本的BaseNN训练得到的模型文件不含有这些信息，因此如果想要将之前的BaseNN训练得到的文件进行转换，需要基于原先的模型文件使用最新的BaseNN版本再进行一轮训练！</p>
<p>模型转换后生成一个ONNX模型和示例代码，示例代码的使用详见<a class="reference external" href="https://xedu.readthedocs.io/zh/master/how_to_use/support_resources/model_convert.html#id8">后文</a>。</p>
</section>
</section>
<section id="id26">
<h2>高级功能<a class="headerlink" href="#id26" title="Permalink to this heading"></a></h2>
<section id="cnn">
<h3>1.提取CNN特征<a class="headerlink" href="#cnn" title="Permalink to this heading"></a></h3>
<p>图像特征提取是计算机视觉中的重要研究领域之一，是计算机视觉中的一个关键步骤，它涉及将图像转换成一组有意义的特征向量，以便于后续的图像分析和识别任务。CNN（卷积神经网络）特征提取方法是一种基于深度学习的特征提取方法，通过卷积层、池化层等多个网络层的处理，可以提取出具有高层次抽象能力的特征表示，被广泛应用于图像分类、目标检测等领域。</p>
<p>BaseNN中提供了一个CNN特征提取工具，可使用BaseNN的<code class="docutils literal notranslate"><span class="pre">model.extract_feature()</span></code>函数通过指定预训练模型来提取图像特征，使用ResNet预训练模型可将一张图像提取为1000维的特征（该预训练模型是在imagenet上训练的千分类模型，所以输出特征的维度是1000维），输出一个1行1000列的数组。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 声明模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="c1"># 读取图像文件</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;small/0/5818.png&#39;</span><span class="p">)</span>
<span class="c1"># 指定resnet18提取图像特征</span>
<span class="n">feature</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">extract_feature</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pretrain</span><span class="o">=</span><span class="s1">&#39;resnet18&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>第一次下载预训练模型有点慢需要耐心等待，再次运行则无需下载。</p>
</section>
<section id="id27">
<h3>2.网络中特征可视化<a class="headerlink" href="#id27" title="Permalink to this heading"></a></h3>
<p>BaseNN内置<code class="docutils literal notranslate"><span class="pre">visual_feature</span></code>函数可呈现数据在网络中传递的过程。特征可视化可以帮助我们更好地理解模型在处理数据时的内部工作原理，并通过这种方式来进一步提高模型的性能和效果。</p>
<p>如输入数据为<strong>图片</strong>，指定图片和已经训练好的模型，可生成一张展示逐层网络特征传递的图片。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">BaseNN</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;mn_ckpt/basenn.pth&#39;</span><span class="p">)</span>          <span class="c1"># 保存的已训练模型载入</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;test_IMG/single_data.jpg&#39;</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>          <span class="c1"># 图片数据读取</span>
<span class="n">model</span><span class="o">.</span><span class="n">visual_feature</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">in1img</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>   <span class="c1"># 特征的可视化</span>
</pre></div>
</div>
<p><img alt="../_images/visualization.png" src="../_images/visualization.png" /></p>
<p>如输入数据为<strong>一维数据</strong>，指定数据和已经训练好的模型，可生成一个txt文件展示经过各层后的输出。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">NumPy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">BaseNN</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;checkpoints/iris_ckpt/basenn.pth&#39;</span><span class="p">)</span>          <span class="c1"># 保存的已训练模型载入</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 指定数据,如测试数据的一行</span>
<span class="n">model</span><span class="o">.</span><span class="n">visual_feature</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>   <span class="c1"># 特征的可视化</span>
</pre></div>
</div>
</section>
<section id="id28">
<h3>3.查看模型结构<a class="headerlink" href="#id28" title="Permalink to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">print_model</span><span class="p">()</span>
</pre></div>
</div>
<p>无参数。</p>
</section>
<section id="id29">
<h3>4.自定义随机数种子<a class="headerlink" href="#id29" title="Permalink to this heading"></a></h3>
<p>默认初始化是随机的，因此每次模型训练效果可能存在差异。可以使用<code class="docutils literal notranslate"><span class="pre">set_seed()</span></code>函数设定随机数种子，使得训练结果可被其他人复现。一旦指定，则每次训练结果一致。使用方法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">1235</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>注：设定随机数种子<code class="docutils literal notranslate"><span class="pre">set_seed()</span></code>应当在搭建网络<code class="docutils literal notranslate"><span class="pre">add()</span></code>之前。在搭建机器学习模型之前，通常建议设置随机数种子。这样做可以使得在每次运行时，生成的随机数序列都是相同的，从而使得模型的可重复性更高。这对于模型调试、验证模型效果、比较不同模型效果等方面都非常有帮助。随机数种子的选择通常应该是随意的，只要您能记住或记录下来使用的种子即可。并且，种子的选择并不会影响模型的效果，只会影响结果的可重复性。</p>
</section>
<section id="id30">
<h3>5.自定义损失函数<a class="headerlink" href="#id30" title="Permalink to this heading"></a></h3>
<p>损失函数（或称目标函数、优化评分函数）是编译模型时所需的参数之一。在机器学习和深度学习中，模型的训练通常涉及到一个优化过程，即通过不断调整模型的参数，使得模型在训练数据上的预测结果与实际结果的差距最小化。这个差距通常使用一个称为”损失函数”的指标来衡量。损失函数通常是一个关于模型参数的函数，用于度量模型预测结果与实际结果之间的差异。在模型训练过程中，模型会根据损失函数的值来调整自己的参数，以减小损失函数的值。</p>
<p>默认的损失函数是交叉熵损失函数，允许选择不同的损失函数，支持的损失函数见<a class="reference external" href="https://xedu.readthedocs.io/zh/master/basenn/appendix.html#id13">附录</a>。自选损失函数方法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;MSELoss&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id31">
<h3>6.自定义评价指标<a class="headerlink" href="#id31" title="Permalink to this heading"></a></h3>
<p>评价指标用于评估当前训练模型的性能。当模型编译后，评价指标应该作为
<code class="docutils literal notranslate"><span class="pre">metrics</span></code>的参数来输入。默认无，需要自行设置评价指标。支持的评价指标：acc（准确率），mae（平均绝对误差），mse（均方误差）。</p>
<p>自选评价指标方法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span><span class="n">metrics</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>当然，在train函数中设置的<code class="docutils literal notranslate"><span class="pre">metrics</span></code>的参数仅是模型在训练集上的评价结果。如需评估模型在验证集上的效果，还需配合模型推理完成。</p>
</section>
<section id="id32">
<h3>由此拓展-自定义评价函数和训练策略<a class="headerlink" href="#id32" title="Permalink to this heading"></a></h3>
<p>一般可以自定义一个分类正确率计算函数来评估模型效果，主要可以通过计算验证集上的分类准确率完成。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义一个计算分类正确率的函数</span>
<span class="k">def</span> <span class="nf">cal_accuracy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pred_y</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pred_y</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">acc</span>

<span class="c1"># 计算分类正确率</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;分类正确率为：&quot;</span><span class="p">,</span><span class="n">cal_accuracy</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>  <span class="c1"># y_val指代验证集的真实值，result指代验证集的推理结果</span>
</pre></div>
</div>
<p>由于model.train在完全训练结束之后，才能进行其他操作，如何判断提前终止训练，或者使用自定义的验证策略来验证模型效果呢？可以用循环来实现。
参考代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="s1">&#39;acc&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">cal_accuracy</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="c1"># 调用自定义的验证计算函数</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;验证集准确率: </span><span class="si">{:.2f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="n">acc</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span> <span class="c1"># 如果准确率大于70%，提前结束训练</span>
        <span class="k">break</span>
</pre></div>
</div>
</section>
<section id="id33">
<h3>7.探秘权重文件<a class="headerlink" href="#id33" title="Permalink to this heading"></a></h3>
<p>BaseNN 0.3.0以上，支持查看pth文件中的权重信息。</p>
<p>首先将pth文件读入一个变量<code class="docutils literal notranslate"><span class="pre">state_dict</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span> 
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;iris_ckpt/basenn.pth&#39;</span><span class="p">)</span>
<span class="n">state_dict</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>1）查看模型里面有哪些层，及各个层的名称</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;这一层的名字是:&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>输出结果：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">layer_name</span><span class="p">:</span> <span class="n">linear1</span><span class="o">.</span><span class="n">weight</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear1</span><span class="o">.</span><span class="n">bias</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear2</span><span class="o">.</span><span class="n">weight</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear2</span><span class="o">.</span><span class="n">bias</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear3</span><span class="o">.</span><span class="n">weight</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear3</span><span class="o">.</span><span class="n">bias</span>
</pre></div>
</div>
<p><img alt="../_images/weight1.png" src="../_images/weight1.png" /></p>
<p>可以看到，权重主要包括两种参数，一种是weight，一种是bias。其中weight，指“重”，特征的重要程度，bias值“偏”，偏离原点的程度。回想一下我们初中学习的一次函数 <code class="docutils literal notranslate"><span class="pre">y=w*x+b</span></code> 就是这样的含义。上图中，每一层都分别有weight和bias构成。</p>
<p>2）查看模型里面上述层的形状（每层的大小）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;层：&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="p">,</span><span class="s2">&quot; 的形状是&quot;</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>输出结果：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">layer_name</span><span class="p">:</span> <span class="n">linear1</span><span class="o">.</span><span class="n">weight</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear1</span><span class="o">.</span><span class="n">bias</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear2</span><span class="o">.</span><span class="n">weight</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear2</span><span class="o">.</span><span class="n">bias</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear3</span><span class="o">.</span><span class="n">weight</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">layer_name</span><span class="p">:</span> <span class="n">linear3</span><span class="o">.</span><span class="n">bias</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p><img alt="../_images/weight2.png" src="../_images/weight2.png" /></p>
<p>通过这一功能，可以简单计算一个模型的参数量有多少。</p>
<p>例如在这个例子中，我们可以计算，参数量一共是：<code class="docutils literal notranslate"><span class="pre">10*4+10+5*10+5+3*5+3</span></code> 个参数。但是通常bias可以忽略不计。至于为什么有<code class="docutils literal notranslate"><span class="pre">10*4</span></code> ，这是因为第一个全连接层用的是size=(4, 10)，这表示，4个神经元的输入层，与10个神经元的隐藏层相连接。这种情况下，4个神经元中的任意一个神经元，都与10个下一层神经元相连接，显然，这里的参数量为10+10+10+10=10*4。</p>
<p>3）查看模型里各层参数的值</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
<p>输出结果：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span><span class="p">:</span> <span class="n">linear1</span><span class="o">.</span><span class="n">weight</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.1671</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2946</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1523</span><span class="p">,</span>  <span class="mf">0.2340</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2319</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2094</span><span class="p">,</span>  <span class="mf">0.8307</span><span class="p">,</span>  <span class="mf">0.7168</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.4024</span><span class="p">,</span>  <span class="mf">0.0528</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4063</span><span class="p">,</span>  <span class="mf">0.3279</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.5091</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0214</span><span class="p">,</span>  <span class="mf">0.9994</span><span class="p">,</span>  <span class="mf">0.5224</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.6709</span><span class="p">,</span>  <span class="mf">1.0019</span><span class="p">,</span>  <span class="mf">0.1012</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8173</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.7910</span><span class="p">,</span>  <span class="mf">0.6090</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6661</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8460</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.3291</span><span class="p">,</span>  <span class="mf">0.1794</span><span class="p">,</span>  <span class="mf">0.3013</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5664</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0976</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1166</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1597</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1705</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2752</span><span class="p">,</span>  <span class="mf">0.3727</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4080</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4774</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.3167</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1678</span><span class="p">,</span>  <span class="mf">1.0979</span><span class="p">,</span>  <span class="mf">0.7183</span><span class="p">]])</span>
<span class="n">layer</span><span class="p">:</span> <span class="n">linear1</span><span class="o">.</span><span class="n">bias</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
<span class="n">tensor</span><span class="p">([</span> <span class="mf">0.0276</span><span class="p">,</span>  <span class="mf">0.0367</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1092</span><span class="p">,</span>  <span class="mf">0.5315</span><span class="p">,</span>  <span class="mf">0.7263</span><span class="p">,</span>  <span class="mf">0.3025</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1470</span><span class="p">,</span>  <span class="mf">0.0737</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">0.1824</span><span class="p">,</span>  <span class="mf">0.0029</span><span class="p">])</span>
<span class="n">layer</span><span class="p">:</span> <span class="n">linear2</span><span class="o">.</span><span class="n">weight</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.1355</span><span class="p">,</span>  <span class="mf">0.7558</span><span class="p">,</span>  <span class="mf">0.0546</span><span class="p">,</span>  <span class="mf">0.1230</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3620</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7619</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3141</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0608</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">0.0821</span><span class="p">,</span>  <span class="mf">0.6960</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2451</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8411</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1880</span><span class="p">,</span>  <span class="mf">0.2396</span><span class="p">,</span>  <span class="mf">0.4853</span><span class="p">,</span>  <span class="mf">1.0186</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0673</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2480</span><span class="p">,</span>
          <span class="mf">0.2201</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7702</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0184</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1989</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2507</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0921</span><span class="p">,</span>  <span class="mf">0.3093</span><span class="p">,</span>  <span class="mf">0.7214</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0233</span><span class="p">,</span>  <span class="mf">0.2101</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">0.2183</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2256</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.1090</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1517</span><span class="p">,</span>  <span class="mf">0.1152</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2598</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0861</span><span class="p">,</span>  <span class="mf">0.1829</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3004</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0835</span><span class="p">,</span>
          <span class="mf">0.0937</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1331</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.1686</span><span class="p">,</span>  <span class="mf">0.8030</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2627</span><span class="p">,</span>  <span class="mf">0.5540</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0460</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4488</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1358</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2360</span><span class="p">,</span>
          <span class="mf">0.0522</span><span class="p">,</span>  <span class="mf">0.7765</span><span class="p">]])</span>
<span class="n">layer</span><span class="p">:</span> <span class="n">linear2</span><span class="o">.</span><span class="n">bias</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span>
<span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.8387</span><span class="p">,</span>  <span class="mf">0.7115</span><span class="p">,</span>  <span class="mf">0.5185</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1147</span><span class="p">,</span>  <span class="mf">0.0033</span><span class="p">])</span>
<span class="n">layer</span><span class="p">:</span> <span class="n">linear3</span><span class="o">.</span><span class="n">weight</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.7702</span><span class="p">,</span>  <span class="mf">0.6576</span><span class="p">,</span>  <span class="mf">0.5163</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0201</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1092</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.1128</span><span class="p">,</span>  <span class="mf">0.2404</span><span class="p">,</span>  <span class="mf">0.2973</span><span class="p">,</span>  <span class="mf">0.3267</span><span class="p">,</span>  <span class="mf">0.1670</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.5992</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0186</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7638</span><span class="p">,</span>  <span class="mf">0.3445</span><span class="p">,</span>  <span class="mf">0.5820</span><span class="p">]])</span>
<span class="n">layer</span><span class="p">:</span> <span class="n">linear3</span><span class="o">.</span><span class="n">bias</span> <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
<span class="n">tensor</span><span class="p">([</span> <span class="mf">0.6430</span><span class="p">,</span>  <span class="mf">0.3829</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1744</span><span class="p">])</span>
</pre></div>
</div>
<p><img alt="../_images/weight3.png" src="../_images/weight3.png" /></p>
<p>我们知道了参数的值之后，可以尝试计算，当一条新数据输入网络后，模型会经历怎样的计算，请你试一试搭建一个简单的神经网络，试一试这个计算过程，你能不能手动实现呢？</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="BaseNN安装或下载" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="projects.html" class="btn btn-neutral float-right" title="BaseNN项目案例集" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2024 OpenXLabEdu.All Rights Reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>